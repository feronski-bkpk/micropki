# Отчет о выполнении Спринта 3

## Общая информация
**Проект:** MicroPKI  
**Спринт:** 3  
**Цель:** Реализация управления жизненным циклом сертификатов и базового хранилища (репозитория) путем внедрения базы данных сертификатов, отслеживания уникальных серийных номеров и REST API для обслуживания точек распространения сертификатов и CRL.

---

## 1. Новые файлы (добавлено)

### `internal/database/db.go`
Пакет для работы с SQLite базой данных:
- `New()` - создание подключения к БД
- `InitSchema()` - инициализация схемы (таблица `certificates` с индексами)
- `InsertCertificate()` - вставка сертификата в БД
- `GetCertificateBySerial()` - получение сертификата по серийному номеру
- `ListCertificates()` - список сертификатов с фильтрацией по статусу/издателю
- `UpdateCertificateStatus()` - обновление статуса (подготовка к отзыву)
- `GetRevokedCertificates()` - получение отозванных сертификатов (для CRL)

### `internal/serial/generator.go`
Пакет для генерации уникальных серийных номеров с проверкой через БД:
- `Generator` - структура с мьютексом для потокобезопасности
- `Generate()` - создание 64-битного составного номера (timestamp + random)
- `GenerateWithEntropy()` - генерация с заданным количеством бит энтропии
- `checkUniqueness()` - проверка уникальности в БД
- `FromHex()` / `FromBigInt()` - конвертеры

### `internal/repository/server.go`
Пакет для HTTP сервера репозитория:
- `Server` - структура HTTP сервера
- `NewServer()` - создание сервера с подключением к БД
- `Start()` - запуск сервера на указанном хосте/порту
- `Stop()` - graceful shutdown
- `loggingMiddleware()` - логирование всех HTTP запросов
- `handleCertificate()` - GET /certificate/<serial>
- `handleCA()` - GET /ca/root и /ca/intermediate
- `handleCRL()` - GET /crl (заглушка для Sprint 4)
- `handleHealth()` - GET /health (проверка работоспособности)
- `tryServeFromFileSystem()` - fallback для обратной совместимости

### `internal/config/config.go`
Пакет для поддержки конфигурационных файлов (опционально):
- `Config` - структура полной конфигурации
- `DatabaseConfig` / `ServerConfig` / `PKIConfig` / `LoggingConfig`
- `DefaultConfig()` - конфигурация по умолчанию
- `Load()` - загрузка из YAML/JSON файла
- `Save()` - сохранение конфигурации
- `applyEnvOverrides()` - переопределение через переменные окружения
- `ExampleConfig()` - пример конфигурационного файла

### `scripts/test-sprint3.sh`
Интеграционный тест-скрипт для проверки всех требований Спринта 3:
- 12 тестов, включая позитивные и негативные сценарии
- Проверка инициализации БД и идемпотентности
- Автоматическая вставка сертификатов
- Тестирование CLI команд (`list-certs`, `show-cert`)
- Запуск HTTP сервера и проверка API
- Негативные тесты (неверный hex, несуществующий сертификат)
- Тест уникальности серийных номеров (100 сертификатов)

---

## 2. Измененные файлы (модифицировано)

### `internal/ca/ca.go`
**Добавлено:**
- `InsertCertificateIntoDB()` - функция для вставки сертификата в БД, вызываемая из команд выпуска
- Интеграция с новым генератором серийных номеров (замена `templates.NewSerialNumber()` на `serial.Generator`)

### `internal/ca/intermediate.go`
**Изменено:**
- Добавлен параметр `--db-path` в конфигурацию
- После успешного создания промежуточного CA происходит автоматическая вставка в БД через `InsertCertificateIntoDB()`

### `micropki/cmd/micropki/main.go`
**Добавлены новые подкоманды:**

**Команды базы данных:**
- `db init` - инициализация SQLite базы данных
  - `--db-path` - путь к файлу БД
  - `--force` - принудительная перезапись

**Новые команды CA для работы с БД:**
- `ca list-certs` - список сертификатов в табличном/JSON/CSV формате
  - `--db-path` - путь к БД
  - `--status` - фильтр по статусу
  - `--format` - формат вывода (table, json, csv)
- `ca show-cert <serial>` - просмотр сертификата по серийному номеру
  - `--db-path` - путь к БД
  - `--format` - формат вывода (pem, text)

**Команды репозитория:**
- `repo serve` - запуск HTTP сервера
  - `--host` / `--port` - адрес и порт
  - `--db-path` - путь к БД
  - `--cert-dir` - директория с сертификатами CA
  - `--log-file` - файл для логов
  - `--config` - путь к конфигурационному файлу
- `repo status` - проверка статуса сервера

**Изменено в существующих командах:**
- `ca issue-intermediate` и `ca issue-cert` - добавлен параметр `--db-path` для автоматической вставки в БД
- Замена генератора серийных номеров с `templates.NewSerialNumber()` на `serial.Generator`

**Добавлены вспомогательные функции:**
- `printCertsTable()` / `printCertsJSON()` / `printCertsCSV()` - форматирование вывода
- `escapeCSV()` - экранирование для CSV формата
- `printCertText()` - читаемый вывод информации о сертификате

### `internal/templates/serial.go`
**Изменено:**
- Файл помечен как устаревший (`deprecated`), но оставлен для обратной совместимости
- Функциональность перенесена в `internal/serial/generator.go`

### `go.mod`
**Добавлены новые зависимости:**
- `github.com/mattn/go-sqlite3 v1.14.22` - драйвер SQLite для Go
- `gopkg.in/yaml.v3 v3.0.1` - поддержка YAML конфигурации (опционально)

### `Makefile`
**Добавлены новые цели:**

**Для тестирования:**
- `test-db` - тестирование пакета database
- `test-repo` - тестирование пакета repository
- `test-serial` - тестирование генератора серийных номеров
- `test-integration-sprint3` - интеграционные тесты спринта 3
- `test-serial-uniqueness` - проверка уникальности 100 серийных номеров

**Для работы с БД и репозиторием:**
- `db-init` - инициализация базы данных
- `list-certs` - просмотр всех сертификатов
- `show-cert SERIAL=<hex>` - просмотр конкретного сертификата
- `repo-serve` - запуск HTTP сервера
- `repo-stop` - остановка сервера
- `repo-status` - проверка статуса
- `test-api` - тестирование API эндпоинтов

**Демонстрационные цели:**
- `example-full` - создание полной PKI иерархии с БД
- `benchmark-db` - тест производительности БД
- `benchmark-serial` - тест производительности генератора

### `README.md`
**Полностью обновлен:**
- Добавлен раздел "Новые возможности Спринта 3"
- Документация по новым командам (`db`, `ca list-certs`, `ca show-cert`, `repo`)
- Раздел "API Репозитория" с описанием всех эндпоинтов
- Обновленные примеры с использованием БД
- Новые Makefile цели в соответствующем разделе
- Обновлена структура проекта с новыми пакетами

---

## 3. Удаленные файлы
Удалений не производилось.

---

## 4. Ключевые изменения в функциональности

### Новые возможности:
1. **База данных SQLite** - централизованное хранение всех сертификатов
2. **Уникальные серийные номера** - 64-битный составной формат (timestamp + random) с проверкой через БД
3. **Автоматическая вставка** - сертификаты автоматически сохраняются в БД при выпуске
4. **Команды для работы с БД** - просмотр, фильтрация, экспорт в JSON/CSV
5. **HTTP репозиторий** - REST API для получения сертификатов:
   - `GET /certificate/<serial>` - по серийному номеру
   - `GET /ca/root` и `/ca/intermediate` - сертификаты CA
   - `GET /crl` - заглушка для будущего CRL
   - `GET /health` - проверка работоспособности
6. **Конфигурационные файлы** - поддержка YAML/JSON конфигурации (опционально)

### Улучшения безопасности:
1. Гарантия уникальности серийных номеров через constraint `UNIQUE` в БД
2. Атомарность операций - при ошибке вставки в БД сертификат не сохраняется на диск
3. Права доступа к БД - директория БД создается с правами 0700

### Интеграция и совместимость:
1. **OpenSSL совместимость** - все сертификаты можно проверять через OpenSSL
2. **REST API** - стандартные HTTP методы и коды ответов
3. **CORS поддержка** - заголовки для браузерных инструментов

### Тестирование:
1. 12 интеграционных тестов в `test-sprint3.sh`
2. Тест уникальности 100 серийных номеров
3. Негативные тесты (неверный hex, несуществующий сертификат)
4. Проверка идемпотентности `db init`
5. Тестирование всех HTTP эндпоинтов