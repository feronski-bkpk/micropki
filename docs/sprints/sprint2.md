# Отчет о выполнении Спринта 2

## Общая информация
**Проект:** MicroPKI  
**Спринт:** 2  
**Цель:** Расширение PKI путем создания промежуточного УЦ и реализации шаблонов сертификатов

---

## 1. Новые файлы (добавлено)

### `internal/templates/templates.go`
Пакет для работы с шаблонами сертификатов:
- `NewServerTemplate()` - шаблон серверного сертификата с SAN (DNS, IP)
- `NewClientTemplate()` - шаблон клиентского сертификата (email, DNS)
- `NewCodeSigningTemplate()` - шаблон для подписи кода
- `NewIntermediateCATemplate()` - шаблон промежуточного УЦ
- `ParseSANString()` - парсинг SAN из формата "type:value"
- `ValidateTemplateCompatibility()` - проверка совместимости SAN с шаблоном

### `internal/templates/serial.go`
- `NewSerialNumber()` - генерация криптостойких серийных номеров (160 бит)

### `internal/csr/csr.go`
Пакет для работы с Certificate Signing Requests:
- `GenerateIntermediateCSR()` - генерация CSR для промежуточного УЦ
- `ParseAndVerifyCSR()` - парсинг и проверка подписи CSR
- `ExtractPublicKey()` - извлечение публичного ключа
- `IsCARequest()` - проверка запроса на CA
- `GetSubjectFromCSR()` - получение субъекта
- `GetSANsFromCSR()` - извлечение SAN из CSR
- `ValidateCSRForTemplate()` - проверка совместимости CSR с шаблоном

### `internal/chain/chain.go`
Пакет для проверки цепочек сертификатов:
- `LoadChain()` - загрузка цепочки из файлов
- `Verify()` - полная проверка цепочки (подписи, сроки, ограничения)
- `VerifyWithOpenSSLCompatibility()` - дополнительная проверка для OpenSSL
- `PrintChainInfo()` - вывод информации о цепочке

### `internal/san/san.go`
Пакет для обработки Subject Alternative Names:
- `ParseSAN()` - парсинг SAN строк
- `ValidateSANTypes()` - проверка типов SAN для шаблона
- `ExtractSANs()` - извлечение SAN из сертификата

### `internal/ca/intermediate.go`
Новый файл с функциями для промежуточного УЦ:
- `IssueIntermediate()` - создание промежуточного УЦ
- `IssueCertificate()` - выпуск сертификатов по шаблонам
- `processExternalCSR()` - обработка внешних CSR

### `scripts/test-sprint2.sh`
Интеграционный тест-скрипт для проверки всех требований Спринта 2:
- 16 тестов, включая позитивные и негативные сценарии
- Проверка всех новых команд
- Валидация расширений через OpenSSL

---

## 2. Измененные файлы (модифицировано)

### `internal/certs/certs.go`
**Добавлено:**
- `LoadCertificate()` - загрузка сертификата из PEM файла
- `SaveCertificate()` - сохранение сертификата в PEM
- `VerifyCertificate()` - проверка сертификата относительно издателя

**Изменено:**
- `VerifySelfSigned()` - улучшена проверка самоподписанных сертификатов

### `internal/crypto/crypto.go`
**Изменено:**
- `GenerateKeyPair()` - теперь поддерживает RSA 2048 и ECC 256 для конечных сертификатов (было только 4096/384)
- Расширена проверка размеров ключей

**Добавлено:**
- `SavePrivateKeyUnencrypted()` - сохранение незашифрованных ключей для конечных сертификатов

### `internal/crypto/crypto_test.go`
**Обновлено:**
- Тесты для новых размеров ключей (2048, 256)
- Тесты для незашифрованного сохранения ключей
- Тесты для граничных случаев

### `micropki/cmd/micropki/main.go`
**Добавлены новые подкоманды:**
- `ca issue-intermediate` - создание промежуточного УЦ
- `ca issue-cert` - выпуск сертификатов по шаблонам
- `ca verify-chain` - проверка полной цепочки

**Изменено:**
- `runCAVerify()` - теперь корректно обрабатывает неподписанные сертификаты
- Добавлена поддержка множественных SAN через `arrayFlags`
- Обновлена справка с новыми командами

### `tests/integration_test.go`
**Изменено:**
- Добавлен тест `TestSprint2Requirements()` для запуска скрипта

### `Makefile`
**Изменения не требовались** - существующие команды работают с новым кодом

---

## 3. Удаленные файлы
Удалений не производилось.

---

## 4. Ключевые изменения в функциональности

### Новые возможности:
1. **Промежуточный УЦ** - создание иерархии CA
2. **Шаблоны сертификатов** - server, client, code_signing
3. **Subject Alternative Names** - поддержка DNS, IP, email, URI
4. **Подпись внешних CSR** - совместимость со сторонними инструментами
5. **Проверка цепочек** - полная валидация по RFC 5280

### Улучшения безопасности:
1. Поддержка RSA 2048 для конечных сертификатов (совместимость)
2. Предупреждения о незашифрованных ключах
3. Валидация SAN по типам шаблонов

### Тестирование:
1. 100% прохождение модульных тестов
2. 16 интеграционных тестов в скрипте
3. Проверка совместимости с OpenSSL