// Package templates содержит вспомогательные типы для работы с шаблонами сертификатов.
// Этот файл определяет тип SerialNumber для работы с серийными номерами X.509 сертификатов.
package templates

import (
	"crypto/rand"
	"fmt"
	"math/big"
)

// SerialNumber оборачивает big.Int для операций с серийными номерами сертификатов.
// Предоставляет удобные методы для генерации и форматирования серийных номеров
// в соответствии с требованиями X.509 и PKI.
type SerialNumber struct {
	// int - внутреннее представление серийного номера
	int *big.Int
}

// NewSerialNumber генерирует новый криптографически безопасный серийный номер.
// Реализует требование PKI-2: минимум 20 бит энтропии (используется 160 бит).
//
// Процесс генерации:
//  1. Генерация 20 байт (160 бит) криптостойких случайных данных
//  2. Сброс старшего бита для гарантии положительного числа (X.509 требование)
//  3. Преобразование в *big.Int
//
// Возвращает:
//   - *SerialNumber: новый серийный номер
//   - error: ошибку, если генератор случайных чисел недоступен
func NewSerialNumber() (*SerialNumber, error) {
	// Генерация 20 байт (160 бит) случайных данных
	bytes := make([]byte, 20)
	if _, err := rand.Read(bytes); err != nil {
		return nil, fmt.Errorf("не удалось сгенерировать серийный номер: %w", err)
	}

	// Обеспечение положительного числа сбросом старшего бита
	bytes[0] &= 0x7F

	return &SerialNumber{
		int: new(big.Int).SetBytes(bytes),
	}, nil
}

// BigInt возвращает внутреннее представление серийного номера как *big.Int.
// Используется при создании шаблонов сертификатов.
func (s *SerialNumber) BigInt() *big.Int {
	return s.int
}

// Hex возвращает шестнадцатеричное представление серийного номера.
// Формат: заглавные буквы, без префикса "0x".
// Пример: "1A2B3C4D5E6F..."
func (s *SerialNumber) Hex() string {
	return fmt.Sprintf("%X", s.int)
}

// String возвращает десятичное представление серийного номера.
// Реализует интерфейс fmt.Stringer.
func (s *SerialNumber) String() string {
	return s.int.String()
}
